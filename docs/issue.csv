标题,内容,测试验收要求,REVIEW要求,完成指标,完成进度,Review指标,Review进度
"确认工作区基线(不回滚)","按当前约束: 不执行回滚; 以当前工作区作为实现基线; 如需对照仅记录 git diff","无需测试; 可选记录 git status/git diff","Review 以当前工作区为 baseline; 后续仅 review 增量变更","已完成","100%","已完成","100%"
"对齐 tools/toolConfig 请求协议","在 src/converter.py 对齐 Node: request.tools 使用 functionDeclarations; toolConfig.functionCallingConfig.mode 固定为 VALIDATED; tool name sanitize 为 ^[a-zA-Z0-9_-]{1,128}$; schema 清洗移除 additionalProperties/anyOf/oneOf/allOf/const/长度数量约束等; 不新增环境变量; 不修改 .env.example","离线转换用例断言: request.tools 结构正确且 toolConfig.mode=VALIDATED; schema 不包含被过滤字段","Review 对照 antigravity2api-nodejs/src/utils/utils.js 的 generateRequestBody/convertOpenAIToolsToAntigravity; 确保无 tools 时不引入 toolConfig; 确保无新增 env vars","已完成","100%","未开始","0%"
"实现 sessionId(不落盘)","为每个 project/token 在进程启动或加载时生成稳定 sessionId(运行时字段); 注入上游 request.sessionId; 不写入 tokens.json(保存时剥离该字段); 不新增环境变量","离线用例覆盖: 同一 TokenManager 实例内 sessionId 稳定; 调用 save_tokens 后文件中不出现 sessionId; openai_to_google 输出包含 request.sessionId","Review 要求: sessionId 只用于上游会话与缓存 key; 不影响持久化格式; 与 Node 行为一致(不落盘)","已完成","100%","未开始","0%"
"实现签名缓存(零配置)","实现 reasoningSignatureCache/toolSignatureCache 进程内缓存, key=sessionId+model; 默认 TTL=30min, 清理间隔=10min, max entries=256; 以上参数 hard-coded 不暴露环境变量; 缺签名时 fallback: message -> cache -> builtin constants","离线用例覆盖: set/get; TTL 过期; 超容量不会无限增长; cache 命中时可补齐缺失 thoughtSignature/tool thoughtSignature","Review 要求: 并发安全(asyncio); 内存上限与清理策略明确; 不修改 .env.example; 不新增 env vars","已完成","100%","未开始","0%"
"补齐多轮必需 thoughtSignature","在将 assistant->model history 时: thinking 模型注入 thought part + thoughtSignature part; tool_call/functionCall 必带 thoughtSignature; fallback: message -> cache(sessionId+model) -> builtin constants; functionCall.id 必贯通 tool_call_id","离线用例覆盖: 缺 thoughtSignature 但 cache 命中时仍可补齐; cache 缺失时落到常量; 多轮 user->assistant(tool_calls)->tool 转换结构正确","Review 重点检查: fallback 顺序与 Node 一致; 只在需要时注入; 不影响非 thinking 模型","已完成","100%","未开始","0%"
"修复 tool response 关联字段","在 src/converter.py 将 role=tool 转为 functionResponse 时: 必须带 id=tool_call_id; response.output 为 string; functionResponse.name 与上一轮 functionCall.name 对齐(必要时从上下文映射)","离线用例覆盖: tool_call_id 能贯通到 functionResponse.id; response.output 始终为字符串; 缺 name 时仍可降级处理","Review 重点检查: id 贯通链路 OpenAI tool_calls[].id -> functionCall.id -> tool_call_id -> functionResponse.id","已完成","100%","未开始","0%"
"对齐响应签名透传与写缓存","在 ResponseConverter 的 stream/non-stream 转换中: 透传 thoughtSignature(reasoning)与 tool_calls[].thoughtSignature(tool)使用 camelCase; 并在服务端将解析到的签名写入缓存(sessionId+model)供下一轮兜底; tool_call.id 优先取上游 functionCall.id","离线用例构造 google response 含 thoughtSignature 与 functionCall.id; 断言 OpenAI 输出包含 thoughtSignature/tool_calls[].id/tool_calls[].thoughtSignature; 并验证 cache 写入","Review 重点检查: 命名与 Node 输出一致; cache 写入不改变响应协议; 无敏感信息日志","已完成","100%","未开始","0%"
"新增离线回归测试","新增 tests/test_tool_calling_conversion.py 覆盖: tools schema 清洗; toolConfig=VALIDATED; sessionId 注入且不落盘; cache 命中/未命中下的 thoughtSignature 兜底; functionCall/functionResponse id 关联; 响应签名透传与 cache 写入","python tests/test_tool_calling_conversion.py 无网络可通过","Review 要求: 不依赖真实 token/上游网络; 断言严格且可读; 失败输出易定位","已完成","100%","未开始","0%"
"集成验证与文档更新","在有真实 token 环境: 启动服务并运行 tests/test_function_calling.py 覆盖 auto/required/specific/多轮/stream; 更新 README 说明多轮 tool calling 对 thoughtSignature 的要求与服务端兜底策略; 不新增环境变量, 不修改 .env.example","tests/test_function_calling.py 多轮测试通过; stream 下能收到 tool_calls; 第二轮 tool 回包能续写出最终 assistant 回复","Review 要求: 文档示例可复制; 变更点与兼容性说明清晰; 日志避免泄露敏感信息","进行中","60%","未开始","0%"
